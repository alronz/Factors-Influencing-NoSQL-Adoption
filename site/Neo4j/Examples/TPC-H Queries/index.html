<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Bilal Al-Saeedi">
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">

	<title>TPC-H Queries - NoSQL Adoption Influencing Factors</title>

        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../../..">NoSQL Adoption Influencing Factors</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Redis <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../../Redis/Redis/">Content</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Basics</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Redis/Basics/Overview/">Overview</a>
</li>

        
            
<li >
    <a href="../../../Redis/Basics/Installation/">Installation</a>
</li>

        
            
<li >
    <a href="../../../Redis/Basics/Underline Structure/">Underline Structure</a>
</li>

        
            
<li >
    <a href="../../../Redis/Basics/Possible Use Cases/">Possible Use Cases</a>
</li>

        
            
<li >
    <a href="../../../Redis/Basics/Query Language/">Query Language</a>
</li>

        
            
<li >
    <a href="../../../Redis/Basics/Transaction Support/">Transaction Support</a>
</li>

        
            
<li >
    <a href="../../../Redis/Basics/Data Import and Export/">Data Import and Export</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Data Model</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Redis/Data Model/Data Layout/">Data Layout</a>
</li>

        
            
<li >
    <a href="../../../Redis/Data Model/Relational Data Support/">Relational Data Support</a>
</li>

        
            
<li >
    <a href="../../../Redis/Data Model/Normalization or Denormalization/">Normalization or Denormalization</a>
</li>

        
            
<li >
    <a href="../../../Redis/Data Model/Nested Data Structures/">Nested Data Structures</a>
</li>

        
            
<li >
    <a href="../../../Redis/Data Model/Referential Integrity/">Referential Integrity</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Query Model</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Redis/Query Model/Query Options/">Query Options</a>
</li>

        
            
<li >
    <a href="../../../Redis/Query Model/Full Text Search Support/">Full Text Search Support</a>
</li>

        
            
<li >
    <a href="../../../Redis/Query Model/Regular Expressions Support/">Regular Expressions Support</a>
</li>

        
            
<li >
    <a href="../../../Redis/Query Model/Aggregation and Filtering/">Aggregation and Filtering</a>
</li>

        
            
<li >
    <a href="../../../Redis/Query Model/Indexing/">Indexing</a>
</li>

        
            
<li >
    <a href="../../../Redis/Query Model/Sorting/">Sorting</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Administration and Maintenance</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Redis/Administration and Maintenance/Configuration/">Configuration</a>
</li>

        
            
<li >
    <a href="../../../Redis/Administration and Maintenance/Scalability/">Scalability</a>
</li>

        
            
<li >
    <a href="../../../Redis/Administration and Maintenance/Persistency/">Persistency</a>
</li>

        
            
<li >
    <a href="../../../Redis/Administration and Maintenance/Backup/">Backup</a>
</li>

        
            
<li >
    <a href="../../../Redis/Administration and Maintenance/Upgrading/">Upgrading</a>
</li>

        
            
<li >
    <a href="../../../Redis/Administration and Maintenance/Security/">Security</a>
</li>

        
            
<li >
    <a href="../../../Redis/Administration and Maintenance/Availability/">Availability</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Special Features</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Redis/Special Features/Scripting Support/">Scripting Support</a>
</li>

        
            
<li >
    <a href="../../../Redis/Special Features/Pub and Sub Support/">Pub and Sub Support</a>
</li>

        
            
<li >
    <a href="../../../Redis/Special Features/Expire Option/">Expire Option</a>
</li>

        
            
<li >
    <a href="../../../Redis/Special Features/Redis as a Cache/">Redis as a Cache</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Examples</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Redis/Examples/Cart Management Service/">Cart Management Service</a>
</li>

        
            
<li >
    <a href="../../../Redis/Examples/Session Management Service/">Session Management Service]</a>
</li>

        
            
<li >
    <a href="../../../Redis/Examples/Cache Service/">Cache Service</a>
</li>

        
            
<li >
    <a href="../../../Redis/Examples/Analytics Service/">Analytics Service</a>
</li>

        
            
<li >
    <a href="../../../Redis/Examples/Job Queue System/">Job Queue System</a>
</li>

        
            
<li >
    <a href="../../../Redis/Examples/Handling Relational Data/">Handling Relational Data</a>
</li>

        
            
<li >
    <a href="../../../Redis/Examples/Bulk Transactions Support/">Bulk Transactions Support</a>
</li>

        
            
<li >
    <a href="../../../Redis/Examples/Transaction Support/">Transaction Support</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Results</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Redis/Results/Strengths and Weaknesses/">Strengths and Weaknesses</a>
</li>

        
            
<li >
    <a href="../../../Redis/Results/Summary/">Summary</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">MongoDB <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../../MongoDB/MongoDB/">Content</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Basics</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../MongoDB/Basics/Overview/">Overview</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Basics/Installation/">Installation</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Basics/Underline Structure/">Underline Structure</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Basics/Possible Use Cases/">Possible Use Cases</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Basics/Query Language/">Query Language</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Basics/Transaction Support/">Transaction Support</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Basics/Data Import and Export/">Data Import and Export</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Data Model</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../MongoDB/Data Model/Data Layout/">Data Layout</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Data Model/Relational Data Support/">Relational Data Support</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Data Model/Normalization or Denormalization/">Normalization or Denormalization</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Data Model/Nested Data Structures/">Nested Data Structures</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Data Model/Referential Integrity/">Referential Integrity</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Query Model</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../MongoDB/Query Model/Query Options/">Query Options</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Query Model/Full Text Search Support/">Full Text Search Support</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Query Model/Regular Expressions Support/">Regular Expressions Support</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Query Model/Aggregation and Filtering/">Aggregation and Filtering</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Query Model/Indexing/">Indexing</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Query Model/Sorting/">Sorting</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Administration and Maintenance</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../MongoDB/Administration and Maintenance/Configuration/">Configuration</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Administration and Maintenance/Scalability/">Scalability</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Administration and Maintenance/Persistency/">Persistency</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Administration and Maintenance/Backup/">Backup</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Administration and Maintenance/Upgrading/">Upgrading</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Administration and Maintenance/Security/">Security</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Administration and Maintenance/Availability/">Availability</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Special Features</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../MongoDB/Special Features/GridFS/">GridFS</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Special Features/Document Validation/">Document Validation</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Examples</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../MongoDB/Examples/TPC-H Queries/">TPC-H Queries</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Results</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../MongoDB/Results/Strengths and Weaknesses/">Strengths and Weaknesses</a>
</li>

        
            
<li >
    <a href="../../../MongoDB/Results/Summary/">Summary</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Neo4j <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../Neo4j/">Content</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Basics</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../Basics/Overview/">Overview</a>
</li>

        
            
<li >
    <a href="../../Basics/Installation/">Installation</a>
</li>

        
            
<li >
    <a href="../../Basics/Underline Structure/">Underline Structure</a>
</li>

        
            
<li >
    <a href="../../Basics/Possible Use Cases/">Possible Use Cases</a>
</li>

        
            
<li >
    <a href="../../Basics/Query Language/">Query Language</a>
</li>

        
            
<li >
    <a href="../../Basics/Transaction Support/">Transaction Support</a>
</li>

        
            
<li >
    <a href="../../Basics/Data Import and Export/">Data Import and Export</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Data Model</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../Data Model/Data Layout/">Data Layout</a>
</li>

        
            
<li >
    <a href="../../Data Model/Relational Data Support/">Relational Data Support</a>
</li>

        
            
<li >
    <a href="../../Data Model/Normalization or Denormalization/">Normalization or Denormalization</a>
</li>

        
            
<li >
    <a href="../../Data Model/Nested Data Structures/">Nested Data Structures</a>
</li>

        
            
<li >
    <a href="../../Data Model/Referential Integrity/">Referential Integrity</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Query Model</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../Query Model/Query Options/">Query Options</a>
</li>

        
            
<li >
    <a href="../../Query Model/Full Text Search Support/">Full Text Search Support</a>
</li>

        
            
<li >
    <a href="../../Query Model/Regular Expressions Support/">Regular Expressions Support</a>
</li>

        
            
<li >
    <a href="../../Query Model/Aggregation and Filtering/">Aggregation and Filtering</a>
</li>

        
            
<li >
    <a href="../../Query Model/Indexing/">Indexing</a>
</li>

        
            
<li >
    <a href="../../Query Model/Sorting/">Sorting</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Administration and Maintenance</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../Administration and Maintenance/Configuration/">Configuration</a>
</li>

        
            
<li >
    <a href="../../Administration and Maintenance/Scalability/">Scalability</a>
</li>

        
            
<li >
    <a href="../../Administration and Maintenance/Persistency/">Persistency</a>
</li>

        
            
<li >
    <a href="../../Administration and Maintenance/Backup/">Backup</a>
</li>

        
            
<li >
    <a href="../../Administration and Maintenance/Upgrading/">Upgrading</a>
</li>

        
            
<li >
    <a href="../../Administration and Maintenance/Security/">Security</a>
</li>

        
            
<li >
    <a href="../../Administration and Maintenance/Availability/">Availability</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Examples</a>
    <ul class="dropdown-menu">
        
            
<li class="active">
    <a href="./">TPC-H Queries</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Results</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../Results/Strengths and Weaknesses/">Strengths and Weaknesses</a>
</li>

        
            
<li >
    <a href="../../Results/Summary/">Summary</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cassandra <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../../Cassandra/Cassandra/">Content</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Basics</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Cassandra/Basics/Overview/">Overview</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Basics/Installation/">Installation</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Basics/Underline Structure/">Underline Structure</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Basics/Possible Use Cases/">Possible Use Cases</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Basics/Query Language/">Query Language</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Basics/Transaction Support/">Transaction Support</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Basics/Data Import and Export/">Data Import and Export</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Data Model</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Cassandra/Data Model/Data Layout/">Data Layout</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Data Model/Relational Data Support/">Relational Data Support</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Data Model/Normalization or Denormalization/">Normalization or Denormalization</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Data Model/Nested Data Structures/">Nested Data Structures</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Data Model/Referential Integrity/">Referential Integrity</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Query Model</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Cassandra/Query Model/Query Options/">Query Options</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Query Model/Full Text Search Support/">Full Text Search Support</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Query Model/Regular Expressions Support/">Regular Expressions Support</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Query Model/Aggregation and Filtering/">Aggregation and Filtering</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Query Model/Indexing/">Indexing</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Query Model/Sorting/">Sorting</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Administration and Maintenance</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Cassandra/Administration and Maintenance/Configuration/">Configuration</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Administration and Maintenance/Scalability/">Scalability</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Administration and Maintenance/Persistency/">Persistency</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Administration and Maintenance/Backup/">Backup</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Administration and Maintenance/Upgrading/">Upgrading</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Administration and Maintenance/Security/">Security</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Administration and Maintenance/Availability/">Availability</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Examples</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Cassandra/Examples/TPC-H Queries/">TPC-H Queries</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Results</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../Cassandra/Results/Strengths and Weaknesses/">Strengths and Weaknesses</a>
</li>

        
            
<li >
    <a href="../../../Cassandra/Results/Summary/">Summary</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../../Administration and Maintenance/Availability/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../Results/Strengths and Weaknesses/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/alronz/NoSQL-Selection-Factors">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#neo4j-examples-tpc-h-queries">Neo4j &gt; Examples &gt; TPC-H Queries</a></li>
        
            <li><a href="#creating-the-data-model">Creating the data model</a></li>
        
            <li><a href="#pricing-summary-report-query-q1">Pricing Summary Report Query (Q1)</a></li>
        
            <li><a href="#shipping-priority-query-q3">Shipping Priority Query (Q3)</a></li>
        
            <li><a href="#order-priority-checking-query-q4">Order Priority Checking Query (Q4)</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p><a href="../../..">Home</a></p>
<p><a href="../../Neo4j/">Neo4j Content</a></p>
<hr />
<h1 id="neo4j-examples-tpc-h-queries">Neo4j &gt; Examples &gt; TPC-H Queries</h1>
<p>In this example, I will show how we can model the data of a complete B2C application and how to write complex queries on this data model. I am going to use the data model used by the <a href="http://www.tpc.org/tpch">TPC-H benchmark</a> which is shown below.</p>
<p><img alt="image" src="https://s3.amazonaws.com/b2cbucket/tpch_schema.png" /></p>
<p>The idea behind this example is to show how to use Neo4j database to design a data model for a real B2C application. Additionally, we want to see how to write advance SQL queries with joins, grouping and sorting using neo4j Cypher language. I have chosen three queries from the TPCH benchmark that I think will cover most of the common query capabilities of SQL. The chosen queries are Q1, Q3 and Q4 as will be explained in the following sections.</p>
<p>The data used as input for this example is a small set from the data generated using TPCH DBGEN tool. The data is stored as CSV files that correspond to each object in the TPCH benchmark schema shown above (customer, supplier, part, lineitem, order , etc ...). For more details about how to generate the data, please have a look at <a href="http://kejser.org/tpc-h-data-and-query-generation/">this</a> blog post. </p>
<p>The complete code of this example can be found in Github along with the steps on how to run it. You can also change the used input data by changing the content of the <a href="https://github.com/alronz/B2C-Database-Selection-Implementations/tree/master/Neo4j/Neo4jTPCHQueries/src/main/java/org/neo4j/tpcH/data">input files</a> stored in the "data" folder.</p>
<h5 id="creating-the-data-model">Creating the data model</h5>
<p>Data model design techniques are explained previously in the <a href="../Data Modeling/data_layout.md">data layout section</a>. Based on these techniques, we have modelled the TPCH data model as shown below:</p>
<p><img alt="image" src="https://s3.amazonaws.com/b2cbucket/tpcHNeo4j.png" /></p>
<p>Although we have 8 entities in the TPCH data model, we have created only 7 node's labels (Supplier,Customer,Order,Nation,Region,Lineitem, and Part) since the Partsupp entity is replaced by a relationship. We have created 6 relationship's types (Contains, Created_By, From, Located_in, Has_details and Supplied_By) that represents all the relationships between the different entities in the TPCH model. The Has_details relationship type is the relationship that replaces the Partsupp entity in the TPCH model and we store inside the relationship the availqty and the supplycost values that comes from the Partsupp entity. </p>
<p>Now after defining the Node's labels and relationship's types, we create the actual nodes and relationships and load them with data using a small set of data generated using the TPCH DBGEN tool as explained previously. We store the data as CSV files inside the data folder, then we iterate through the files line by line and create the corresponding nodes and relationships. To see the complete code, please have a look at the <a href="https://github.com/alronz/B2C-Database-Selection-Implementations/blob/master/Neo4j/Neo4jTPCHQueries/src/main/java/org/neo4j/tpcH/TPCHModel.java">TPCHModel.java</a> file. </p>
<p>I will show below the main logic followed and an example code of two functions one to create nodes with label "Lineitem" and the other to create relationships with type "CONTAINS". All other nodes and relationships are created when calling the initialiseData() function. </p>
<pre><code>// Creating all the nodes with label &quot;Lineitem&quot;

void createLineItemNodes() {

        File file = new File(&quot;src/main/java/org/neo4j/tpcH/data/lineitem.txt&quot;);

        // Create a unique constraint on the LINENUMBER property

        try (Transaction tx = this.graphDb.beginTx()) {

            this.graphDb.schema().constraintFor(DynamicLabel.label(&quot;Lineitem&quot;))
                    .assertPropertyIsUnique(&quot;LINENUMBER&quot;).create();
            tx.success();
        } catch (Exception e) {
            System.out
                    .println(&quot;unique constraint on LINENUMBER creation failed&quot;);
            System.out.println(&quot;Error is &quot; + e.getLocalizedMessage());
        }

        try (BufferedReader br = new BufferedReader(new FileReader(file))) {
            String line;

            if (this.graphDb == null) {
                System.out.println(&quot;graphDb is null&quot;);
            }

            while ((line = br.readLine()) != null) {
                // process the line.

                String[] lineFields = line.split(Pattern.quote(&quot;|&quot;));

                // System.out.println(Arrays.toString(lineFields));

                try (Transaction tx = this.graphDb.beginTx()) {

                    Node Lineitem = this.graphDb.createNode(DynamicLabel
                            .label(&quot;Lineitem&quot;));
                    Lineitem.setProperty(&quot;LINENUMBER&quot;, lineFields[3]);
                    Lineitem.setProperty(&quot;QUANTITY&quot;, Double.valueOf(lineFields[4]));
                    Lineitem.setProperty(&quot;EXTENDEDPRICE&quot;, Double.valueOf(lineFields[5]));
                    Lineitem.setProperty(&quot;DISCOUNT&quot;, Double.valueOf(lineFields[6]));
                    Lineitem.setProperty(&quot;TAX&quot;, Double.valueOf(lineFields[7]));
                    Lineitem.setProperty(&quot;RETURNFLAG&quot;, lineFields[8]);
                    Lineitem.setProperty(&quot;LINESTATUS&quot;, lineFields[9]);
                    Lineitem.setProperty(&quot;SHIPDATE&quot;, format.parse(lineFields[10]).getTime());
                    Lineitem.setProperty(&quot;COMMITDATE&quot;, format.parse(lineFields[11]).getTime());
                    Lineitem.setProperty(&quot;RECEIPTDATE&quot;, format.parse(lineFields[12]).getTime());
                    Lineitem.setProperty(&quot;SHIPINSTRUCT&quot;, lineFields[13]);
                    Lineitem.setProperty(&quot;SHIPMODE&quot;, lineFields[14]);
                    Lineitem.setProperty(&quot;COMMENT&quot;, lineFields[15]);

                    System.out.println(&quot;Lineitem node with LINENUMBER: &quot;
                            + lineFields[0] + &quot; have been created&quot;);
                    tx.success();
                } catch (Exception e) {
                    System.out.println(&quot;Lineitem node with LINENUMBER: &quot;
                            + lineFields[0] + &quot;  creation failed&quot;);
                    System.out.println(&quot;Error is &quot; + e.getLocalizedMessage());
                }

            }

        } catch (FileNotFoundException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        } catch (IOException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }

    }


</code></pre>

<p>As seen from the code above, we first create a unique constraint on the LINENUMBER property for all the nodes with the "Lineitem" label. This constraint is needed to make sure that we aren't creating the same node twice. Then we iterate through the Lineitem CSV file and create a new node with label "Lineitem" for each line in the file. Note that we first create a transaction before creating each node or when creating the unique constraint and commit the transaction at the end if no error was raised. </p>
<p>We do the same as the function above to create nodes for all other node's labels (Supplier,Customer,Order,Nation,Region, and Part). The functions are createCustomerNodes(), createSupplierNodes(), createNationNodes(), createOrderNodes(), createPartNodes() and createRegionNodes().</p>
<p>To create the CONTAINS relationships as an example, we iterate through the Lineitem CSV file. Then for each line we get the order node that has the ORDERKEY as a property inside the node. In the same way, we get the order node that has the LINENUMBER as a property inside the node. Finally we create a relationship that starts from the order node and ends at the lineitem node and make sure that this relationship doesn't already exist to prevent creating the same relationship twice. The code is shown below:</p>
<pre><code>
void createContainsRelationship() {

        File file = new File(&quot;src/main/java/org/neo4j/tpcH/data/lineitem.txt&quot;);

        try (BufferedReader br = new BufferedReader(new FileReader(file))) {
            String line;

            if (this.graphDb == null) {
                System.out.println(&quot;graphDb is null&quot;);
            }

            while ((line = br.readLine()) != null) {
                // process the line.

                String[] lineFields = line.split(Pattern.quote(&quot;|&quot;));

                // System.out.println(Arrays.toString(lineFields));

                try (Transaction tx = this.graphDb.beginTx()) {

                    Node lineitemNode = this.graphDb.findNode(
                            DynamicLabel.label(&quot;Lineitem&quot;), &quot;LINENUMBER&quot;,
                            lineFields[3]);

                    Node orderNode = this.graphDb.findNode(
                            DynamicLabel.label(&quot;Order&quot;), &quot;ORDERKEY&quot;,
                            lineFields[0]);

                    Iterable&lt;Relationship&gt; orderRelationships = orderNode
                            .getRelationships();
                    Iterator&lt;Relationship&gt; orderRelationshipsIterator = orderRelationships
                            .iterator();

                    boolean relExists = false;

                    while (orderRelationshipsIterator.hasNext()) {
                        Relationship rel = orderRelationshipsIterator.next();

                        if (rel.getEndNode().equals(lineitemNode)) {
                            relExists = true;
                        }
                    }

                    if (!relExists) {
                        orderNode.createRelationshipTo(lineitemNode,
                                RelTypes.CONTAINS);

                        System.out
                                .println(&quot;CONTAINS relationship have been created&quot;);
                    }

                    tx.success();
                } catch (Exception e) {
                    System.out.println(&quot;CONTAINS relationship creation failed&quot;);
                    System.out.println(&quot;Error is &quot; + e.getLocalizedMessage());
                }

            }

        } catch (FileNotFoundException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        } catch (IOException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }

    }

</code></pre>

<p>After creating all the nodes and relationships, it will look like the below:</p>
<p><img alt="image" src="https://s3.amazonaws.com/b2cbucket/neo4jdata.png" /></p>
<p>Now after we have our data model ready, we can try to run queries on it. As mentioned before, we have chosen three queries from the TPCH benchmarks to try them in Neo4j as will be shown in the following sections.</p>
<h5 id="pricing-summary-report-query-q1">Pricing Summary Report Query (Q1)</h5>
<p>This query is used to report the amount of billed, shipped and returned items. The SQL query is shown below:</p>
<pre><code>select
   l_returnflag,
   l_linestatus,
   sum(l_quantity) as sum_qty,
   sum(l_extendedprice) as sum_base_price,
   sum(l_extendedprice*(1-l_discount)) as sum_disc_price,
   sum(l_extendedprice*(1-l_discount)*(1+l_tax)) as sum_charge,
   avg(l_quantity) as avg_qty,
   avg(l_extendedprice) as avg_price,
   avg(l_discount) as avg_disc,
   count(*) as count_order
from
   lineitem
where
   l_shipdate &lt;= date '1998-12-01' - interval '[DELTA]' day (3)
group by
   l_returnflag,
   l_linestatus
order by
   l_returnflag,
   l_linestatus;
</code></pre>

<p>Writing a similar query in Neo4j using Cypher is simple as shown below:</p>
<pre><code>MATCH (item:Lineitem)
WHERE item.SHIPDATE  &lt;= 912524220000
RETURN item.RETURNFLAG,item.LINESTATUS,sum(item.QUANTITY) AS sum_qty, sum(item.EXTENDEDPRICE) AS sum_base_price, sum(item.EXTENDEDPRICE*(1-item.DISCOUNT)) AS sum_disc_price,sum(item.EXTENDEDPRICE*(1-item.DISCOUNT)*(1+item.TAX)) AS sum_charge,avg(item.QUANTITY) AS avg_qty, avg(item.EXTENDEDPRICE) AS avg_price, avg(item.DISCOUNT) AS avg_disc
ORDER BY item.RETURNFLAG, item.LINESTATUS
</code></pre>

<p>Basically, we are searching all the nodes that are having the "Lineitem" label, filter the results using the shipdate property of the node and return only the fields that are needed in the original SQL query. You can also easily use mathematical operations on the returned fields exactly as we do with SQL and use the built-in aggregate function of Neo4j such as min, max, sum, avg, and count.  The aggregation is done automatically in Cypher and there is no need to provide a group by statement. Sorting is done using the ORDER BY statement exactly as we use it in SQL. The only difference is that the Cypher language has no date support, therefore we have stored the date properties as long value representing the Epoch time. When you store the date using the Epoch long value, we will be able to run range queries on the property as we have done above.</p>
<p>The complete implementation of the API call that will retrieve the results for Q1 is shown below:</p>
<pre><code>
    @GET
    @Path(&quot;/q1&quot;)
    @Timed
    @ApiOperation(value = &quot;get result of TPCH Q1 using this model&quot;, notes = &quot;TPCH Queries&quot;, response = String.class)
    @ApiResponses(value = {@ApiResponse(code = 500, message = &quot;internal server error !&quot;)})
    public String getQ1Results() {

        Result result = null;


        try {

            try (Transaction trans = this.graphDb.beginTx()) {

                String query1 = &quot;MATCH (item:Lineitem)\n&quot; +
                        &quot;WHERE item.SHIPDATE  &lt;= &quot; + format.parse(&quot;1998-12-01&quot;).getTime() + &quot; \n&quot; +
                        &quot;RETURN item.RETURNFLAG,item.LINESTATUS,sum(item.QUANTITY) AS sum_qty, sum(item.EXTENDEDPRICE) AS sum_base_price, sum(item.EXTENDEDPRICE*(1-item.DISCOUNT)) AS sum_disc_price,\n&quot; +
                        &quot;sum(item.EXTENDEDPRICE*(1-item.DISCOUNT)*(1+item.TAX)) AS sum_charge,avg(item.QUANTITY) AS avg_qty, avg(item.EXTENDEDPRICE) AS avg_price, avg(item.DISCOUNT) AS avg_disc\n&quot; +
                        &quot;ORDER BY item.RETURNFLAG, item.LINESTATUS&quot;;

                result = this.graphDb
                        .execute(query1);

                trans.success();
            }

            return result.resultAsString();
        } catch (Exception e) {
            LOGGER.log(Level.SEVERE,
                    &quot;internal server error !&quot; + e.getLocalizedMessage());
            final String shortReason = &quot;internal server error !&quot;;
            Exception cause = new IllegalArgumentException(shortReason);
            throw new WebApplicationException(cause,
                    javax.ws.rs.core.Response.Status.INTERNAL_SERVER_ERROR);
        }
    }

</code></pre>

<p>A sample result of the above query is shown below:</p>
<p><img alt="image" src="https://s3.amazonaws.com/b2cbucket/q1ResultNeo4j.png" /></p>
<h5 id="shipping-priority-query-q3">Shipping Priority Query (Q3)</h5>
<p>This query is used to get the 10 unshipped orders with the highest value. In order to do that, the query joins three tables (customer, order and lineitem) as shown below:</p>
<pre><code>select
 l_orderkey,
 sum(l_extendedprice*(1-l_discount)) as revenue,
 o_orderdate,
 o_shippriority
from
 customer,
 orders,
 lineitem
where
 c_mktsegment = '[SEGMENT]'
 and c_custkey = o_custkey
 and l_orderkey = o_orderkey
 and o_orderdate &lt; date '[DATE]'
 and l_shipdate &gt; date '[DATE]'
group by
 l_orderkey,
 o_orderdate,
 o_shippriority
order by
 revenue desc,
 o_orderdate;
</code></pre>

<p>Writing a similar Cypher query for the above SQL is also simple as shown below:</p>
<pre><code>MATCH  (item:Lineitem) &lt;-[:CONTAINS]- (order:Order ) -[:CREATED_BY]-&gt; (customer:Customer)
WHERE order.ORDERDATE &lt; 912524220000 AND item.SHIPDATE &gt; 631205820000 AND customer.MKTSEGMENT = 'AUTOMOBILE' 
RETURN order.ORDERKEY, sum(item.EXTENDEDPRICE*(1-item.DISCOUNT)) AS REVENUE, order.ORDERDATE, order.SHIPPRIORITY
ORDER BY REVENUE DESC, order.ORDERDATE
</code></pre>

<p>As we can see above, representing relationships and joins in Cypher is very simple where we just want to use the MATCH statement (MATCH  (item:Lineitem) &lt;-[:CONTAINS]- (order:Order ) -[:CREATED_BY]-&gt; (customer:Customer)). We are searching for any node that have the "Order" label and is connected to another node with label "Lineitem" by a relationship with type "Contains". Then we filter the results by the order.ORDERDATE, item.SHIPDATE and  customer.MKTSEGMENT using the WHERE statement. Aggregation and ordering is done in a similar way like Q1.</p>
<p>The complete implementation of the API call that will retrieve the results for Q3 is shown below:</p>
<pre><code>
    @GET
    @Path(&quot;/q3&quot;)
    @Timed
    @ApiOperation(value = &quot;get result of TPCH Q3 using this model&quot;, notes = &quot;TPCH Queries&quot;, response = String.class)
    @ApiResponses(value = {@ApiResponse(code = 500, message = &quot;internal server error !&quot;)})
    public String getQ3Results() {

        Result result = null;

        try {
            try (Transaction trans = this.graphDb.beginTx()) {

                String query3 = &quot;MATCH  (item:Lineitem) &lt;-[:CONTAINS]- (order:Order ) -[:CREATED_BY]-&gt; (customer:Customer)\n&quot; +
                        &quot;WHERE order.ORDERDATE &lt; 912524220000 AND item.SHIPDATE &gt; 631205820000 AND customer.MKTSEGMENT = 'AUTOMOBILE' \n&quot; +
                        &quot;RETURN order.ORDERKEY, sum(item.EXTENDEDPRICE*(1-item.DISCOUNT)) AS REVENUE, order.ORDERDATE, order.SHIPPRIORITY\n&quot; +
                        &quot;ORDER BY REVENUE DESC, order.ORDERDATE&quot;;

                result = this.graphDb
                        .execute(query3);

                trans.success();
            }

            return result.resultAsString();
        } catch (Exception e) {
            LOGGER.log(Level.SEVERE,
                    &quot;internal server error !&quot; + e.getLocalizedMessage());
            final String shortReason = &quot;internal server error !&quot;;
            Exception cause = new IllegalArgumentException(shortReason);
            throw new WebApplicationException(cause,
                    javax.ws.rs.core.Response.Status.INTERNAL_SERVER_ERROR);
        }
    }


</code></pre>

<p>If you call the above API, you will get a reply like the one shown below:</p>
<p><img alt="image" src="https://s3.amazonaws.com/b2cbucket/q3ResultNeo4.png" /></p>
<h5 id="order-priority-checking-query-q4">Order Priority Checking Query (Q4)</h5>
<p>This query is used to see how well the order priority system is working and gives indication of the customer satisfaction. The SQL query is shown below:</p>
<pre><code>select
 o_orderpriority,
 count(*) as order_count
from
 orders
where
 o_orderdate &gt;= date '[DATE]'
 and o_orderdate &lt; date '[DATE]' + interval '3' month
 and exists (
select
 *
from
 lineitem
where
 l_orderkey = o_orderkey
 and l_commitdate &lt; l_receiptdate
)
group by
 o_orderpriority
order by
 o_orderpriority;
</code></pre>

<p>The above query can be represented in Cypher as shown below:</p>
<pre><code>MATCH  (order:Order) -[:CONTAINS]-&gt; (item:Lineitem) 
WHERE item.COMMITDATE &lt; item.RECEIPTDATE AND order.ORDERDATE &gt;= 631205820000 AND order.ORDERDATE &lt; 912524220000
RETURN order.ORDERPRIORITY, count(*) AS ORDER_COUNT
ORDER BY order.ORDERPRIORITY
</code></pre>

<p>So we have represented the join part between the Lineitem entity and the Order entity using the MATCH clause (MATCH  (order:Order) -[:CONTAINS]-&gt; (item:Lineitem)) so that we search for any node having the "Lineitem" label that is connected to a node with the "Order" label by a relationship with type "CONTAINS". Then we filter the results using the item.COMMITDATE and the order.ORDERDATE. Finally we return only the fields that we require and sort the data using the ORDER BY clause. </p>
<p>The complete implementation of the API call that will retrieve the results for Q4 is shown below:</p>
<pre><code>    @GET
    @Path(&quot;/q4&quot;)
    @Timed
    @ApiOperation(value = &quot;get result of TPCH Q4 using this model&quot;, notes = &quot;TPCH Queries&quot;, response = String.class)
    @ApiResponses(value = {@ApiResponse(code = 500, message = &quot;internal server error !&quot;)})
    public String getQ4Results() {

        Result result = null;

        try {
            try (Transaction trans = this.graphDb.beginTx()) {

                String query4 = &quot;MATCH  (order:Order) -[:CONTAINS]-&gt; (item:Lineitem) \n&quot; +
                        &quot;WHERE item.COMMITDATE &lt; item.RECEIPTDATE AND order.ORDERDATE &gt;= 631205820000 AND order.ORDERDATE &lt; 912524220000\n&quot; +
                        &quot;RETURN order.ORDERPRIORITY, count(*) AS ORDER_COUNT\n&quot; +
                        &quot;ORDER BY order.ORDERPRIORITY&quot;;

                result = this.graphDb
                        .execute(query4);

                trans.success();
            }

            return result.resultAsString();
        } catch (Exception e) {
            LOGGER.log(Level.SEVERE,
                    &quot;internal server error !&quot; + e.getLocalizedMessage());
            final String shortReason = &quot;internal server error !&quot;;
            Exception cause = new IllegalArgumentException(shortReason);
            throw new WebApplicationException(cause,
                    javax.ws.rs.core.Response.Status.INTERNAL_SERVER_ERROR);
        }
    }
</code></pre>

<p>If you call the above API, you will get results as shown below:</p>
<p><img alt="image" src="https://s3.amazonaws.com/b2cbucket/q4ResultsNeo4j.png" /></p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
                <p>Copyright Â© 2016 <a href="https://sa.linkedin.com/in/bilal-al-saeedi-4b185a18">Bilal Al-Saeedi </a></p>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script>
        <script>var base_url = '../../..';</script>
        <script data-main="../../../mkdocs/js/search.js" src="../../../mkdocs/js/require.js"></script>
        <script src="../../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
